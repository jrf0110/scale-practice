<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="/css/core.gen.css">

    <script src="/bower_components/jquery/jquery.js"></script>
    <script src="/bower_components/async/lib/async.js"></script>
    <script src="/bower_components/sugar/release/sugar-full.development.js"></script>
    <script src="/bower_components/audiosynth/audiosynth.js"></script>
    <script>
      // Returns the first truthy value
      Array.prototype.firstMap = function( fn ){
        for ( var i = 0, l = this.length, val; i < l; ++i ){
          if ( val = fn( this[ i ], i, this ) ) return val;
        }
        return null;
      };

      Array.prototype.transpose = function(){
        this.unshift( this.pop() );
        return this;
      };

      Function.prototype.defaults = function(){
        var this_ = this, defaults = Array.prototype.slice.call( arguments );
        return function(){
          var args = Array.prototype.slice.call( arguments ).concat(
            defaults.slice( arguments.length )
          );
          return this_.apply( this, args );
        }
      };
    </script>

    <script>
      var syn = (function(){
        var AudioContext = [
          'webkit'
        , 'moz'
        , ''
        ].firstMap( function( prefix ){
          return window[ prefix + 'AudioContext' ];
        });

        // C4 technically, but I'll call it C0
        var baseFrequency = 261.3; 
        var twelthRootOfTwo = Math.pow( 2, 1 / 12 );
        var numOctaves = 8;
        var notes = [];
        var noteFrequencyTable = {};

        var noSharps = [ 'B', 'E' ]
        for ( var i = 'A'; i <= 'G'; i = String.fromCharCode( i.charCodeAt() + 1 )){
          notes.push( i );

          if ( noSharps.indexOf( i ) === -1 ){
            notes.push( i + '#' )
          }
        }

        // Shift `C` to the beginning
        while ( notes[ 0 ] !== 'C' ) notes.transpose();

        for ( var o = 0, n, steps, l = notes.length; o < numOctaves; ++o ){
          steps = l * o;
          for ( n = 0; n < l; ++n ){
            noteFrequencyTable[ notes[ n ] + o ] = ( baseFrequency * (
              Math.pow( twelthRootOfTwo, steps + n )
            )).round(2);
          }
        }

        var player = {
          init: function( frequencies, context, destination ){
            var this_ = this;

            this.frequencies  = frequencies;
            this.destination  = destination;
            this.context      = context;

            this.oscillators = frequencies.map( function( f ){
              var osc = context.createOscillator();
              osc.type.value = 0;
              osc.frequency.value = f;

              // Unify the competing browser interfaces
              osc.start = ( osc.noteOn || osc.start ).defaults(0).bind( osc );
              osc.stop = ( osc.noteOff || osc.stop ).defaults(0).bind( osc );

              osc.connect( destination );

              return osc;
            });

            return this;
          }

        , play: function( delay ){
            this.oscillators.forEach( function( osc ){
              osc.start();
            });

            return this;
          }

        , stop: function( delay ){
            var this_ = this;

            setTimeout( function(){
              this_.oscillators.forEach( function( osc ){
                osc.stop();
                osc.disconnect();
              });
            }, delay * 1000 );

            return this;
          }
        };

        var synthesizer = {
          noteFrequencyTable: noteFrequencyTable

        , init: function( options ){
            var context = this.context = new AudioContext();
            this.gainNode = context.createGainNode();
            this.gainNode.connect( context.destination );

            return this;
          }

        , playFrequencies: function( frequencies, delay ){
            if ( typeof frequencies === 'number' ){
              frequencies = [ frequencies ];
            }

            return Object.create( player ).init(
              frequencies, this.context, this.gainNode
            ).play( delay );
          }

        , play: function( notes, delay ){
            var this_ = this;

            if ( !Array.isArray( notes ) ){
              notes = [ notes ];
            }

            var frequencies = notes.map( function( note ){
              return this_.noteFrequencyTable[ note.id + note.octave ];
            });

            return Object.create( player ).init(
              frequencies, this.context, this.gainNode
            ).play( delay );
          }
        };

        return {
          createSynthesizer: function( options ){
            return Object.create( synthesizer ).init( options );
          }
        };
      })();

      var config = {
        settings: {
          instruments: [
            { name: 'Guitar', id: 'acoustic' }
          // , { name: 'Piano', id: 'piano' }
          ]

        , keys: [
            { name: 'C', id: 'C' }
          , { name: 'C#', id: 'C#' }
          , { name: 'D', id: 'D' }
          , { name: 'E&#x266d;', id: 'D#' }
          , { name: 'E', id: 'E' }
          , { name: 'F', id: 'F' }
          , { name: 'F#', id: 'F#' }
          , { name: 'G', id: 'G' }
          , { name: 'G#', id: 'G#' }
          , { name: 'A', id: 'A' }
          , { name: 'B&#x266d;', id: 'A#' }
          , { name: 'B', id: 'B' }
          ]

        , exercises: [
            {
              name: 'The Major Scale (Single Octave)'
            , id: 'major-one-octave'
            , definition: [
                { string: 0, pos: 0  }, { string: 0, pos: 2 }
              , { string: 1, pos: -1 }, { string: 1, pos: 0 }, { string: 1, pos: 2 }
              , { string: 2, pos: -1 }, { string: 2, pos: 1 }, { string: 2, pos: 2 }
              ]
            }
          , {
              name: 'The Major Scale (Double Octave)'
            , id: 'major-two-octave'
            , definition: [
                { string: 0, pos: 0  }, { string: 0, pos: 2 }
              , { string: 1, pos: -1 }, { string: 1, pos: 0 }, { string: 1, pos: 2 }
              , { string: 2, pos: -1 }, { string: 2, pos: 1 }, { string: 2, pos: 2 }
              , { string: 3, pos: -1 }, { string: 3, pos: 1 }, { string: 3, pos: 2 }
              , { string: 4, pos: 0  }, { string: 4, pos: 2 }
              , { string: 5, pos: -1 }, { string: 5, pos: 0 }
              ]
            }
          , {
              name: 'The Minor Scale (Single Octave)'
            , id: 'minor-one-octave'
            , definition: [
                { string: 0, pos: 0  }, { string: 0, pos: 2 }, { string: 0, pos: 3 }
              , { string: 1, pos: 0  }, { string: 1, pos: 2 }, { string: 1, pos: 3 }
              , { string: 2, pos: 0  }, { string: 2, pos: 2 }
              ]
            }
          , {
              name: 'The Minor Scale (Double Octave)'
            , id: 'minor-two-octave'
            , definition: [
                { string: 0, pos: 0  }, { string: 0, pos: 2 }, { string: 0, pos: 3 }
              , { string: 1, pos: 0  }, { string: 1, pos: 2 }, { string: 1, pos: 3 }
              , { string: 2, pos: 0  }, { string: 2, pos: 2 }
              , { string: 3, pos: -1 }, { string: 3, pos: 0 }, { string: 3, pos: 2 }
              , { string: 4, pos: 0  }, { string: 4, pos: 1 }, { string: 4, pos: 3 }
              , { string: 5, pos: 0  }
              ]
            }
          , {
              name: 'Alternate 1 Minor'
            , id: 'alternate-1-minor'
            , definition: [
                { string: 0, pos: 0  }, { string: 0, pos: 2 }, { string: 0, pos: 3 }
              , { string: 2, pos: 0  }, { string: 2, pos: 2 }
              , { string: 1, pos: 0  }, { string: 1, pos: 2 }, { string: 1, pos: 3 }
              , { string: 3, pos: -1 }, { string: 3, pos: 0 }, { string: 3, pos: 2 }
              , { string: 2, pos: 0  }, { string: 2, pos: 2 }
              , { string: 4, pos: 0  }, { string: 4, pos: 1 }, { string: 4, pos: 3 }
              , { string: 3, pos: -1 }, { string: 3, pos: 0 }, { string: 3, pos: 2 }
              , { string: 5, pos: 0  }, { string: 5, pos: 2 }, { string: 5, pos: 3 }
              ]
            }
          ]

        , tempo: 200
        , octave: 3
        }

      , sampleRate: 20000
      , volume: 0.6
      , noteDuration: 2
      , noteMin: 1

      , guitarStrings: [
          { id: 'E', octave: 0 }
        , { id: 'A', octave: 0 }
        , { id: 'D', octave: 1 }
        , { id: 'G', octave: 1 }
        , { id: 'B', octave: 1 }
        , { id: 'E', octave: 2 }
        ]

      , guitarNumFrets: 16
      };

      var playFourClicks = (function(){
        var synth = Synth.createInstrument('piano');

        return function( callback ){
          callback = callback || function(){};

          // The volume for this seems to really low
          Synth.setVolume( 1 );

          var durationSec = 1 / (app_state.tempo / 60);
          var durationMicro = durationSec * 1000;

          async.series(
            [ 0, 4 ].series().map( function(){
              return  function( done ){
                synth.play( 'C', 6, 0.1 );
                setTimeout( done, durationMicro );
              };
            })
          , function(){
              Synth.setVolume( config.volume );
              callback();
            }
          );
        };
      })();

      var guitarNotes = {};

      var Guitar = function( options ){
        var defaults = {
          frets: 16
        , strings: config.guitarStrings.slice(0)
        , synthName: 'acoustic'
        , defaultDuration: 3
        };

        this.options = $.extend( {}, defaults, options );
        
        this.synth = Synth.createInstrument( this.options.synthName );
        this.initNotes();

        return this;
      };

      Guitar.prototype.initNotes = function(){
        var this_ = this;

        this.notes = {};

        this.options.strings.forEach( function( str, i ){
          var keys  = config.settings.keys;
          var notes = this_.notes[ str.id ] = this_.notes[ i ] = [];
          var start = keys.findIndex( function( k ){
            return k.id === str.id;
          });

          for ( var i = 0, l = keys.length; i < this_.options.frets; i++ ){
            notes.push({
              id:       keys[ ( start + i ) % l ].id
            , octave:   str.octave + Math.floor( ( start + i ) / l )
            });
          }
        });
      };

      Guitar.prototype.play = function( notes ){
        for ( var i = 0, l = notes.length, note; i < l; ++i ){
          if ( 'string' in notes[ i ] ){
            note = this.notes[ notes[ i ].string ][ notes[ i ].fret ];
          }

          this.synth.play(
            notes[ i ].id       || note.id
          , notes[ i ].octave   || note.octave
          , notes[ i ].duration || this.options.duration
          );
        }

        return this;
      };

      var stepsFrom = function( n1, n2 ){
        var steps = 0, keys = config.settings.keys, l = keys.length;
        var start = keys.findIndex( function( k ){
          return k.id === n1;
        });

        while ( keys[ start++ % l ].id !== n2 ) steps++;

        return steps;
      };

      var noteAt = function( n1, steps ){
        if ( steps === 0 ) return n1;

        var keys = config.settings.keys;
        var start = keys.findIndex( function( k ){
          return k.id === n1;
        });

        return keys[ (start + steps) % keys.length ].id;
      };

      // var ex = config.settings.exercises.find( function( ex ){
      //   return ex.id === 'alternate-1-minor';
      // });

      // config.settings.exercises.push({
      //   "name": "Minor Postion Thing 1"
      // , "id": "minor-position-thing-1"
      // , "definition": [5,26,17,2,8,10,12,22,14,17,12,14,15,19,10,24,3,0,20,15,7,27]
      // , "guitarIntervalStringMap": ex.guitarIntervalStringMap
      // });

      // var majorTwo = config.settings.exercises.push({
      //   name: 'The Major Scale (Two Octaves)'
      // , id: 'major-two-octave'
      // , definition: config.settings.exercises[0].definition
      // , guitarIntervalStringMap: config.settings.exercises[0].guitarIntervalStringMap
      // });

      // majorTwo = config.settings.exercises[ majorTwo - 1 ];

      // majorTwo.definition = majorTwo.definition.slice( 0, Math.floor(majorTwo.definition.length / 2) + 1 );

      // majorTwo.definition = majorTwo.definition.concat(
      //   majorTwo.definition.slice(1).map( function( n, i, a ){
      //     return a[ a.length - 1 ] + n;
      //   })
      // );

      // majorTwo.definition = majorTwo.definition.concat(
      //   majorTwo.definition.slice(0, majorTwo.definition.length - 1 ).reverse()
      // );

      // config.settings.exercises.push({
      //   name: 'Random Minor 1'
      // , id: 'random-minor-1'
      // , definition: ex.definition.slice(0).randomize()
      // , guitarIntervalStringMap: ex.guitarIntervalStringMap
      // });

      // // Reversable exercises
      // [
      //   'alternate-1-minor'
      // ].forEach( function( reversable ){
      //   var exercise = config.settings.exercises.find( function( ex ){
      //     return ex.id === reversable;
      //   });

      //   config.settings.exercises.push({
      //     name:                     exercise.name + ' Reversed'
      //   , id:                       exercise.id + '-reversed'
      //   , definition:               exercise.definition.slice(0).reverse()
      //   , guitarIntervalStringMap:  exercise.guitarIntervalStringMap
      //   });
      // });

      // Mirrorable exercises
      [
        // 'major-one-octave'
      ].forEach( function( mirrorable ){
        var exercise = config.settings.exercises.find( function( ex ){
          return ex.id === mirrorable;
        });

        exercise.definition = exercise.definition.concat( exercise.definition.slice(
          0, exercise.definition.length - 1
        ).reverse() );
      });

      config.settings.exercises = config.settings.exercises.sort( function( a, b ){
        return a.name > b.name;
      });

      var app_state = {
        instrument: 'acoustic'
      , key: 'C'
      , exercise: 'major-one-octave'
      , tempo: config.settings.tempo
      , octave: config.settings.octave
      , repeat: false
      , reverse: false
      };

      $.fn.instrument = function( options ){
        var $this = this;

        var defaults = {
          keyboardNumOctaves: 3
        , guitarNumFrets: 16
        , guitarNumStrings: 6
        , onNoteClick: function( note, e ){}
        , keyboardTemplate: function( keys ){
            return [
              '<div class="keyboard">'
            , '  <div class="black-keys">'
            ,    keys.black
            , '  </div>'
            , '  <div class="white-keys">'
            ,    keys.white
            , '  </div>'
            , '</div>'
            ].join('');
          }
        , keyboardKeyTemplate: function( key ){
            return [
              '<div class="note keyboard-key'
            , ( key.note.length > 1 ? ' keyboard-key-black' : '' )
            , ( key.note.active ? ' active' : '' )
            , '"'
            , ' data-note="', key.note, '"'
            , ' data-octave="', key.octave, '"'
            , '></div>'
            ].join('');
          }

        , guitarTemplate: function( options ){
            return [
              '<div class="guitar">'
            , '  <div class="notes">'
            ,    options.notes
            , '  </div>'
            , '  <div class="strings">'
            ,    options.strings
            , '  </div>'
            , '  <div class="fretboard">'
            ,    options.frets
            , '  </div>'
            , '</div>'
            ].join('');
          }

        , guitarStringTemplate: function(){
            return [
              '<div class="string"></div>'
            ].join('');
          }

        , guitarFretTemplate: function(){
            return [
              '<div class="fret"></div>'
            ].join('');
          }

        , guitarNoteStringTemplate: function( frets ){
            return [
              '<div class="string">'
            , frets
            , '</div>'
            ].join('');
          }

        , guitarNoteFretTemplate: function( key ){
            return [
              '<div class="note fret"'
            , ' data-note="', key.note, '"'
            , ' data-octave="', key.octave, '"'
            , '></div>'
            ].join('');
          }
        };

        options = $.extend( {}, defaults, options );

        var plugin = {
          render: function(){
            if ( app_state.instrument === 'piano' ){
              plugin.renderPiano();
            } else if ( app_state.instrument === 'acoustic' ){
              plugin.renderGuitar();
            }

            $this.find('.note').on( 'mousedown', function( e ){
              var $el = $( e.target );
              options.onNotePress(
                {
                  id: $el.data('note')
                , octave: $el.data('octave') + (
                            app_state.instrument === 'piano'
                              ? app_state.octave : 0
                          )
                }
              , e
              );
            });
          }

        , renderPiano: function(){
            var keys = { white: '', black: '' };
            for ( var i = 0; i < options.keyboardNumOctaves; i++ ){
              keys.black += config.settings.keys.filter( function( key ){
                return key.id.length > 1;
              }).map( function( key ){
                return options.keyboardKeyTemplate({ note: key.id, octave: i });
              }).join('\n');

              keys.white += config.settings.keys.filter( function( key ){
                return key.id.length === 1;
              }).map( function( key ){
                return options.keyboardKeyTemplate({ note: key.id, octave: i });
              }).join('\n');
            }

            $this.html( options.keyboardTemplate( keys ) );
          }

        , renderGuitar: function(){
            var guitar = { strings: '', frets: '', notes: '' };
            var i, ii, frets, noteIndex, string;

            for ( i = 0; i < options.guitarNumStrings; i++ ){
              frets = "";
              string = config.guitarStrings[ i ];
              noteIndex = config.settings.keys.findIndex( function( key ){
                return key.id === string.id;
              });

              for ( ii = 0; ii < options.guitarNumFrets; ii++ ){
                frets += options.guitarNoteFretTemplate({
                  octave: string.octave + Math.floor( ( noteIndex + 1 + ii ) / (config.settings.keys.length ) )
                , note: config.settings.keys[
                    ( noteIndex + 1 + ii ) % config.settings.keys.length
                  ].id
                });
              }

              guitar.notes += options.guitarNoteStringTemplate( frets );
            }

            for ( i = 0; i < options.guitarNumStrings; i++ ){
              guitar.strings += options.guitarStringTemplate();
            }

            for ( i = 0; i < options.guitarNumFrets; i++ ){
              guitar.frets += options.guitarFretTemplate();
            }

            $this.html( options.guitarTemplate( guitar ) );
          }

        , highlightNotes: function( notes ){
            plugin.clearHighlight();
            $this.find(
              notes.map( function( note ){
                return [
                  '.notes > .string:nth-child(' + (note.string + 1) + ') '
                , ' .note:nth-child(' + note.fret + ')'
                ].join('');
              }).join(', ')
            ).addClass('active');
          }

        , clearHighlight: function(){
            $this.find('.note.active').removeClass('active');
          }

        , play: function( notes ){
            $this.find(
              notes.map( function( note ){
                return [
                  '.notes > .string:nth-child(' + (note.string + 1) + ') '
                , ' .note:nth-child(' + note.fret + ')'
                ].join('');
              }).join(', ')
            ).trigger('mousedown');
          }
        };

        plugin.render();

        return plugin;
      };

      $.fn.app_settings = function( options ){
        var $this = this;

        var defaults = {
          optionTmpl: function( option ){
            return [
              '<option value="'
            , option.id
            , '"'
            , option.selected ? ' selected="true"' : ''
            , '>'
            , option.name
            , '</option>'
            ].join('');
          }
        , selects: [
            { name: 'instrument', settings_key: 'instruments' }
          , { name: 'key',        settings_key: 'keys' }
          , { name: 'exercise',   settings_key: 'exercises' }
          ]
        , onInstrumentChange: function( instrument, e ){}
        , onKeyChange:        function( key, e ){}
        , onExerciseChange:   function( exercise, e ){}
        , onTempoChange:      function( tempo, e ){}
        , onRepeatChange:     function( repeat, e ){}
        , onReverseChange:     function( reverse, e ){}
        , onPlay:             function( e ){}
        , onStop:             function( e ){}
        };

        options = $.extend( {}, defaults, options );

        var plugin = {
          render: function(){
            options.selects.forEach( function( setting ){
              $this.find('[name="' + setting.name + '"]').html(
                config.settings[ setting.settings_key ].map( function( i ){
                  if ( i.id === app_state[ setting.name ] ) i.selected = true;
                  return i;
                }).map( options.optionTmpl )
              ).on( 'change', function( e ){
                options[
                  [
                    'on'
                  , setting.name[0].toUpperCase() + setting.name.slice(1)
                  , 'Change'
                  ].join('')
                ]( e.target.value, e );
              });
            });

            $this.find('[name="tempo"]').val(
              app_state.tempo
            ).blur( function( e ){
              options.onTempoChange( +e.target.value, e );
            });

            $this.find('[name="play"]').click( function( e ){
              if ( e.target.innerHTML === 'Stop' ){
                e.target.innerHTML = 'Play';
                options.onStop( e );
              } else {
                e.target.innerHTML = 'Stop';
                options.onPlay( e );
              }
            });

            // Checkboxes
            [
              'reverse'
            , 'repeat'
            ].forEach( function( prop ){
              $this.find('[name="' + prop + '"]').attr(
                'checked', app_state.repeat
              ).on( 'change', function( e ){
                options[ [
                  'on'
                , prop[0].toUpperCase() + prop.slice(1)
                , 'Change'
                ].join('') ]( !!e.target.checked, e );
              });
            });

          }
        };

        plugin.render();

        return plugin;
      };

      Synth.setSampleRate( config.sampleRate );
      Synth.setVolume( config.volume );

      var mySynth = syn.createSynthesizer();
      // var instrument = Synth.createInstrument( app_state.instrument );
      // var guitar = new Guitar();

      // Play a mostly inaudible prep sound so the audio API is ready
      // to go whenever the user interacts
      mySynth.playFrequencies( 10 ).stop(0.00000001);

      $(function(){
        var playExercise = function( key, exercise, callback ){
          callback = callback || function(){};

          if ( exercise.definition.length === 0 ) return callback();

          var rootString = config.guitarStrings[ exercise.definition[0].string ].id;
          var rootFret = stepsFrom( rootString, app_state.key );

          var durationSec = 1 / (app_state.tempo / 60);
          var durationMicro = durationSec * 1000;
          var keyStart = config.settings.keys.findIndex( function( k ){
            return k.id === key;
          });

          fns = exercise.definition.map( function( step ){
            return function( next ){
              if ( playExercise.stop ) return next(true);

              if ( app_state.instrument === 'acoustic' ){
                var notes = [{
                  fret: rootFret + step.pos
                , string: step.string
                , duration: durationSec
                }];

                guitar.play( notes );
                webkitRequestAnimationFrame( instrumentView.highlightNotes.fill( notes ) );
              } else {
                instrumentView.highlightNotes([
                  { id: noteId, octave: octave }
                ]);
              }

              setTimeout( next, durationMicro );
            };
          });

          if ( app_state.reverse ){
            fns = fns.concat( fns.slice( 0, fns.length - 1 ).reverse() );
          }

          fns = [ playFourClicks ].concat( fns );

          return async.series( fns, function(){
            if ( app_state.repeat && playExercise.stop !== true ){
              return playExercise( key, exercise, callback );
            }

            playExercise.stop = false;
            instrumentView.clearHighlight();
            callback();
          });
        };

        playExercise.stop = false;

        $('.app-settings').app_settings({
          onKeyChange: function( key ){
            if ( key === 'E' ){
              return alert('Sorry, the key of `E` is broken right now lol');
            }
            app_state.key = key;
          }

        , onTempoChange: function( tempo ){
            app_state.tempo = tempo;
          }

        , onExerciseChange: function( exercise ){
            app_state.exercise = exercise;
          }

        , onRepeatChange: function( repeat ){
            app_state.repeat = repeat;
          }

        , onReverseChange: function( reverse ){
            app_state.reverse = reverse;
          }

        , onPlay: function( e ){
            playExercise( app_state.key, config.settings.exercises.find( function( e ){
              return e.id === app_state.exercise;
            }), function(){
              e.target.innerHTML = 'Play';
            });
          }

        , onStop: function(){
            playExercise.stop = true;
          }
        });

        var instrumentView = $('.instrument').instrument({
          onNotePress: function( note, e ){
            // guitar.play([{
            //   id:       note.id
            // , octave:   note.octave
            // , duration: config.noteDuration
            // }]);
            mySynth.play({
              id:       note.id
            , octave:   note.octave
            }).stop( config.noteDuration );
          }
        });
      });
    </script>
  </head>
  <body>
    <div class="app-settings">
      <select name="instrument" class="setting-control"></select>
      <select name="key" class="setting-control"></select>
      <select name="exercise" class="setting-control"></select>
      <input  name="tempo" type="number">
      <button name="play">Play</button>
      <input  name="reverse" type="checkbox" id="checkbox-reverse">
      <label for="checkbox-reverse">Reverse</label>
      <input  name="repeat" type="checkbox" id="checkbox-repeat">
      <label for="checkbox-repeat">Repeat</label>
    </div>
    <div class="instrument"></div>
  </body>
</html>